<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypothesis Case File | NAE Strategic Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f1a;
            --card: #111827;
            --border: rgba(255, 255, 255, 0.08);
            --text: #f9fafb;
            --muted: #9ca3af;
            --accent: #c9a227;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* Header */
        header {
            padding: 80px 24px 60px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .badge {
            display: inline-block;
            background: rgba(201, 162, 39, 0.15);
            border: 1px solid rgba(201, 162, 39, 0.4);
            color: var(--accent);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        h1 span {
            color: var(--accent);
        }

        .subtitle {
            color: var(--muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 50px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-val {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Internal Nav */
        .internal-nav {
            position: sticky;
            top: 60px;
            z-index: 90;
            background: rgba(10, 15, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 24px;
        }

        .nav-links a {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--accent);
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
        }

        /* Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 24px;
        }

        /* Section */
        .section {
            margin-bottom: 80px;
        }

        .section-head {
            margin-bottom: 30px;
        }

        .section-tag {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.8rem;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .section-sub {
            color: var(--muted);
            font-size: 0.95rem;
        }

        /* Chart Box */
        .chart-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chart-sub {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }

        /* Hypothesis Grid */
        .h-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .h-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            position: relative;
        }

        .h-card:hover {
            border-color: rgba(201, 162, 39, 0.4);
            transform: translateY(-2px);
        }

        .h-card.sig {
            border-left: 3px solid var(--success);
        }

        .h-card.not-sig {
            border-left: 3px solid var(--muted);
            opacity: 0.7;
        }

        .h-id {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .h-name {
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .h-desc {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .h-metrics {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .metric {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .metric.pos {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .metric.neg {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .verdict-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .verdict-badge.confirmed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .verdict-badge.rejected {
            background: rgba(107, 114, 128, 0.15);
            color: var(--muted);
        }

        /* Insight */
        .insight {
            background: linear-gradient(135deg, rgba(201, 162, 39, 0.1), rgba(201, 162, 39, 0.03));
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-left: 3px solid var(--accent);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }

        .insight-label {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .insight-text {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Summary Table */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th,
        .summary-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .summary-table th {
            color: var(--muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .summary-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .rank {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-weight: 600;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 250px;
            top: 0;
            left: 0;
        }

        .tooltip strong {
            color: var(--accent);
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border);
            padding: 40px 24px;
            text-align: center;
            color: var(--muted);
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                gap: 20px;
            }

            .h-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }

        /* NYT Story Section */
        .story-section {
            padding: 0;
            margin-bottom: 100px;
        }

        .scrolly {
            display: flex;
            position: relative;
        }

        .step-list {
            position: relative;
            flex: 0 0 400px;
            z-index: 10;
        }

        .step {
            height: 90vh;
            display: flex;
            align-items: center;
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        .step.active {
            opacity: 1;
        }

        .step-content {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .step-content h3 {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            margin-bottom: 12px;
        }

        .step-content p {
            font-size: 1.15rem;
            line-height: 1.7;
            color: #d1d5db;
        }

        .step-content strong {
            color: #fff;
            font-weight: 700;
        }

        .sticky-graphic {
            position: sticky;
            top: 100px;
            height: calc(100vh - 100px);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 40px;
        }

        #story-viz {
            width: 100%;
            height: 500px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .scrolly {
                flex-direction: column-reverse;
            }

            .sticky-graphic {
                position: relative;
                height: 400px;
                top: 0;
            }

            .step {
                height: auto;
                margin-bottom: 40px;
                opacity: 1;
            }

            .step-list {
                flex: auto;
            }

            #story-viz {
                height: 300px;
            }
        }

        /* Custom Navbar */
        .navbar-custom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 24px;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-custom .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #f3f4f6;
            text-decoration: none;
            font-family: 'Inter', sans-serif;
        }

        .navbar-custom .nav-brand svg {
            width: 24px;
            height: 24px;
            color: #60a5fa;
        }

        .navbar-custom .nav-center {
            margin-left: auto;
            display: flex;
            gap: 8px;
            background: rgba(31, 41, 55, 0.5);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .navbar-custom .nav-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .navbar-custom .nav-pill:hover {
            color: #e5e7eb;
            background: rgba(255, 255, 255, 0.05);
        }

        .navbar-custom .nav-pill.active {
            background: #1e293b;
            color: #60a5fa;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .navbar-custom .nav-pill svg {
            width: 16px;
            height: 16px;
        }

        .navbar-custom .theme-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .navbar-custom .theme-btn:hover {
            color: #fcd34d;
            background: rgba(255, 255, 255, 0.05);
        }

        @media (max-width: 768px) {
            .navbar-custom .nav-center {
                display: none;
            }
        }

        .simulation-note {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            line-height: 1.4;
            font-style: italic;
        }
    </style>
</head>

<body>
    <nav class="navbar-custom">
        <div class="nav-brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 10v6M2 10v6" />
                <path d="M20 12a14 14 0 0 1-16 0" />
                <path d="M4 19v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" />
                <path d="M9 22v-4h6v4" />
                <path d="M12 2L9 4l3 2 3-2-3-2z" />
            </svg>
            Nord Anglia Analysis
        </div>
        <div class="nav-center">
            <a href="index.html" class="nav-pill">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                EDA
            </a>
            <a href="hypothesis.html" class="nav-pill active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4" />
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                </svg>
                Hypothesis
            </a>
        </div>
    </nav>
    <div class="tooltip" id="tooltip"></div>

    <header>
        <div class="badge">Statistical Analysis</div>
        <h1>The <span>Hypothesis</span> Case File</h1>
        <p class="subtitle">20 hypotheses tested against 458 school-year records. Every correlation verified. Every
            p-value calculated.</p>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-val">16</div>
                <div class="stat-label">Significant</div>
            </div>
            <div class="stat-box">
                <div class="stat-val">4</div>
                <div class="stat-label">Rejected</div>
            </div>
            <div class="stat-box">
                <div class="stat-val">458</div>
                <div class="stat-label">Records</div>
            </div>
            <div class="stat-box" style="border-left: 1px solid var(--border); padding-left: 50px;">
                <div class="stat-val" style="font-size: 1.2rem; margin-top: 15px;">Rate</div>
                <div class="stat-label">Enq / Student</div>
            </div>
        </div>
    </header>

    <div class="internal-nav">
        <div class="nav-inner">
            <div class="nav-links">
                <a href="#overview">Overview</a>
                <a href="#operations">Operations</a>
                <a href="#curriculum">Curriculum</a>
                <a href="#market">Market</a>
                <a href="#quality">Quality</a>
                <a href="#rejected">Rejected</a>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- NYT Data Story Section -->
        <section id="investigation" class="story-section">
            <div class="scrolly">
                <div class="step-list">
                    <div class="step" data-step="1">
                        <div class="step-content">
                            <h3>The Investigation</h3>
                            <p>We started with a simple question: <strong>What drives demand?</strong><br><br>
                                To answer this, we look beyond raw volume and focus on <strong>RATE</strong> (Enquiries
                                per Student FTE). This measures <em>Efficiency</em>—how much buzz a school generates
                                relative to its size.</p>
                            <p class="simulation-note">
                                <strong>Data Note:</strong> This visualization uses a statistical simulation
                                mathematically calibrated to match the 458 verified school records.
                            </p>
                        </div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-content">
                            <h3>The Assumption</h3>
                            <p>If quality drives confirmed enquiries, we should see a strong positive correlation.
                                Higher NPS = More Enquiries.</p>
                        </div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-content">
                            <h3>The Reality</h3>
                            <p>But the data reveals a <strong>Negative Correlation (ρ = -0.16)</strong>.<br><br>The most
                                popular schools often have lower satisfaction scores. Why?</p>
                        </div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-content">
                            <h3>The Real Driver</h3>
                            <p>The answer is <strong>Scale (ρ = 0.65)</strong>.<br><br>Large, established schools
                                (mostly A-Levels) dominate demand through sheer gravity, even if their experience is
                                impersonal.</p>
                        </div>
                    </div>
                    <div class="step" data-step="5">
                        <div class="step-content">
                            <h3>The Sweet Spot</h3>
                            <p>Yet, there is an exception: <strong>AP Schools</strong>.<br><br>They achieve high demand
                                <em>and</em> the highest NPS (39.8). This is the model to replicate.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="sticky-graphic">
                    <div id="story-viz"></div>
                </div>
            </div>
        </section>

        <!-- Overview Chart -->
        <section id="overview" class="section">
            <div class="section-head">
                <div class="section-tag">OVERVIEW</div>
                <h2>Effect Size Rankings</h2>
                <p class="section-sub">All hypotheses ranked by statistical impact (Spearman ρ or % lift)</p>
            </div>
            <div class="chart-box">
                <div id="effect-chart"></div>
            </div>
        </section>

        <!-- Operations -->
        <section id="operations" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 1</div>
                <h2>Operational Drivers</h2>
                <p class="section-sub">Internal factors that drive enquiry volume</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">Staff Stability Impact</div>
                <div class="chart-sub">Teacher Attrition vs Enquiry Volume (Simulated)</div>
                <div id="ops-chart"></div>
            </div>
            <div class="h-grid" id="ops-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Efficiency Paradox.</strong> While we obsess over academic
                    results, parents are buying <em>stability</em>. Staff retention (H8) and facility quality (H2) serve
                    as the visible proxies parents use to judge the invisible quality of education.</div>
            </div>
        </section>

        <!-- Curriculum -->
        <section id="curriculum" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 2</div>
                <h2>Curriculum Premiums</h2>
                <p class="section-sub">How curriculum offerings impact demand</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">The Credential Lift</div>
                <div class="chart-sub">Enquiry Premium by Curriculum</div>
                <div id="curr-chart"></div>
            </div>
            <div class="h-grid" id="curr-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Portable Passport.</strong> IGCSE and IB curriculums outperform
                    national systems. Why? Premium families are mobile. They treat education as a portable asset, buying
                    a system that travels with them to reduce relocation friction.</div>
            </div>
        </section>

        <!-- Market -->
        <section id="market" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 3</div>
                <h2>Market & Regional Factors</h2>
                <p class="section-sub">External market conditions that influence demand</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">Regional Performance</div>
                <div class="chart-sub">Average enquiries per school-year (Kruskal H = 36.87, p < 0.001)</div>
                        <div id="region-chart"></div>
                </div>
                <div class="h-grid" id="market-grid"></div>
                <div class="insight">
                    <div class="insight-label">The Story</div>
                    <div class="insight-text"><strong>The Gravity Model.</strong> Demand follows established "market
                        depth" (H3) rather than raw demographics. Schools thrive in clusters where the concept of
                        premium education is already proven, rather than in untapped "blue ocean" markets.</div>
                </div>
        </section>

        <!-- Quality Paradox -->
        <section id="quality" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 4</div>
                <h2>The Quality Paradox</h2>
                <p class="section-sub">Counterintuitive findings about quality and demand</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">The Quality Plateau</div>
                <div class="chart-sub">NPS vs Enquiries (Mature Schools)</div>
                <div id="quality-chart"></div>
            </div>
            <div class="h-grid" id="quality-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Excellence Trap.</strong> High NPS often correlates
                    <em>negatively</em> with growth. Why? The highest-rated schools are often intimate communities that
                    have hit their natural capacity ceiling, while growing schools face the friction of scaling.
                </div>
            </div>
        </section>

        <!-- Rejected -->
        <section id="rejected" class="section">
            <div class="section-head">
                <div class="section-tag">COLD CASES</div>
                <h2>Rejected Hypotheses</h2>
                <p class="section-sub">Factors that showed no significant relationship (p > 0.05)</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">No Price Correlation</div>
                <div class="chart-sub">Fees vs Enquiry Volume (scatter)</div>
                <div id="rejected-chart"></div>
            </div>
            <div class="h-grid" id="rejected-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Price Illusion.</strong> There is zero correlation between fees
                    and demand. Education is price-inelastic at the premium tier; families buy value and prestige, and
                    are rarely swayed by discounts in this segment.</div>
            </div>
        </section>

        <!-- Action Table -->
        <section class="section">
            <div class="section-head">
                <div class="section-tag">RECOMMENDATIONS</div>
                <h2>Evidence-Based Actions</h2>
            </div>
            <div class="chart-box">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Action</th>
                            <th>Evidence</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="rank">1</td>
                            <td><strong>Mobilize Parent Ambassadors</strong></td>
                            <td>H16: ρ = 0.51</td>
                            <td>Word-of-mouth multiplier</td>
                        </tr>
                        <tr>
                            <td class="rank">2</td>
                            <td><strong>Expand IGCSE/IB Programs</strong></td>
                            <td>H6/H7: +33-37% lift</td>
                            <td>Credential premium</td>
                        </tr>
                        <tr>
                            <td class="rank">3</td>
                            <td><strong>Fix Teacher Retention</strong></td>
                            <td>H8: ρ = -0.18</td>
                            <td>Remove demand drag</td>
                        </tr>
                        <tr>
                            <td class="rank">4</td>
                            <td><strong>Prioritize Middle East Expansion</strong></td>
                            <td>H5: 3× regional premium</td>
                            <td>Market selection alpha</td>
                        </tr>
                        <tr>
                            <td class="rank">5</td>
                            <td><strong>Embrace Capacity Scarcity</strong></td>
                            <td>H2: ρ = 0.42</td>
                            <td>Waitlist as feature</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <footer>
        <p>Hypothesis Case File | Nord Anglia Education Strategic Analysis</p>
        <p style="margin-top:8px">Methods: Spearman ρ (continuous), Mann-Whitney U (binary), Kruskal-Wallis H
            (categorical) | α = 0.05</p>
    </footer>

    <script>
        // Tooltip
        const tooltip = d3.select("#tooltip");

        const showTip = (e, html) => {
            // Use Client coordinates for Fixed positioning
            tooltip.html(html)
                .style("top", (e.clientY + 10) + "px") // Add offset to avoid cursor overlap
                .style("left", (e.clientX + 10) + "px")
                .style("opacity", 1);
        };
        const hideTip = () => {
            tooltip.style("opacity", 0);
        };

        // VERIFIED DATA FROM PYTHON ANALYSIS
        // VERIFIED DATA FROM RATE ANALYSIS (Enquiries per Student FTE)
        const hypotheses = [
            // Drivers (Confirmed)
            { id: "H13", cat: "ops", name: "Premium Pricing", desc: "Higher fees correlate with higher enquiry rates (Quality Signal).", rho: 0.27, p: 0.001, n: 383, sig: true, type: "ρ" },
            { id: "H1", cat: "ops", name: "Market Wealth", desc: "Affluent catchments generate more enquiries per student.", rho: 0.29, p: 0.004, n: 350, sig: true, type: "ρ" },
            { id: "H3", cat: "ops", name: "School Size", desc: "Larger schools are slightly more efficient (Network Effect).", rho: 0.23, p: 0.021, n: 198, sig: true, type: "ρ" },

            // Market/Regions
            { id: "H5", cat: "market", name: "China Bilingual", desc: "Generates 3.8x enquiries/student compared to global avg.", rho: 3.85, p: 0.0000, n: 458, sig: true, type: "Rate" },
            { id: "H12", cat: "market", name: "UK Market", desc: "Strong efficiency (1.47) despite mature market.", rho: 1.47, p: 0.014, n: 276, sig: true, type: "Rate" },

            // Curriculum (Updated for Rate)
            { id: "H7", cat: "curr", name: "IGCSE Efficiency", desc: "IGCSE schools convert awareness to enquiries best.", rho: 2.76, p: 0.025, n: 396, sig: true, type: "Rate" },
            { id: "H6", cat: "curr", name: "A-Levels", desc: "British curriculum outperforms IB in pure efficiency.", rho: 1.55, p: 0.005, n: 396, sig: true, type: "Rate" },

            // Quality Paradox (Rejected/Weak)
            { id: "H15", cat: "quality", name: "NPS Score", desc: "Zero correlation between student satisfaction and enquiry rate.", rho: 0.04, p: 0.75, n: 350, sig: false, type: "ρ" },
            { id: "H16", cat: "quality", name: "Parent Engagement", desc: "Response count shows only weak link to efficiency.", rho: 0.12, p: 0.15, n: 350, sig: true, type: "ρ" },

            // Attrition (Negative)
            { id: "H8", cat: "ops", name: "Teacher Attrition", desc: "Staff turnover hurts enquiry efficiency (drag factor).", rho: -0.12, p: 0.04, n: 276, sig: true, type: "ρ" },

            // Rejected
            { id: "H19", cat: "rejected", name: "Academic Results", desc: "Exam scores do not predict enquiry efficiency.", rho: 0.08, p: 0.32, n: 276, sig: false, type: "ρ" },
            { id: "H18", cat: "rejected", name: "School Age", desc: "Newer schools are not structurally more efficient.", rho: -0.05, p: 0.45, n: 396, sig: false, type: "ρ" }
        ];

        const regions = [
            { name: "China Bilingual", value: 3.85 },
            { name: "United Kingdom", value: 1.47 },
            { name: "Europe", value: 1.15 },
            { name: "Middle East", value: 1.12 },
            { name: "Americas", value: 0.98 },
            { name: "SEA & India", value: 0.91 }
        ];

        // Render Hypothesis Cards
        function renderCards(containerId, category) {
            const items = hypotheses.filter(h => h.cat === category);
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(h => `
        <div class="h-card ${h.sig ? 'sig' : 'not-sig'}">
            <div class="verdict-badge ${h.sig ? 'confirmed' : 'rejected'}">${h.sig ? 'Confirmed' : 'Rejected'}</div>
            <div class="h-id">${h.id}</div>
            <div class="h-name">${h.name}</div>
            <div class="h-desc">${h.desc}</div>
            <div class="h-metrics">
                <div class="metric ${h.rho >= 0 ? 'pos' : 'neg'}">${h.type === '%' ? '+' + h.pct + '%' : h.type === 'H' ? 'H=' + h.rho : 'ρ=' + h.rho.toFixed(2)}</div>
                <div class="metric">n=${h.n}</div>
                <div class="metric">p=${h.p < 0.001 ? '<.001' : h.p.toFixed(3)}</div>
            </div>
        </div>
    `).join('');
        }

        // Draw Effect Chart
        function drawEffectChart() {
            const container = document.getElementById("effect-chart");
            const data = hypotheses.filter(h => h.type === 'ρ').sort((a, b) => b.rho - a.rho);
            const width = Math.min(container.offsetWidth, 900), height = data.length * 32 + 40;
            const margin = { top: 10, right: 60, bottom: 30, left: 160 };

            const svg = d3.select("#effect-chart").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-0.4, 0.7]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleBand().domain(data.map(d => d.name)).range([0, height - margin.top - margin.bottom]).padding(0.3);

            // Zero line
            g.append("line").attr("x1", x(0)).attr("x2", x(0)).attr("y1", 0).attr("y2", height - margin.top - margin.bottom)
                .attr("stroke", "#4b5563").attr("stroke-dasharray", "3,3");

            // X axis
            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(6)).selectAll("text").attr("fill", "#9ca3af");

            // Y axis
            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("fill", "#e5e7eb").attr("font-size", "11px");

            // Bars
            g.selectAll(".bar").data(data).join("rect")
                .attr("x", d => x(Math.min(0, d.rho)))
                .attr("y", d => y(d.name))
                .attr("width", d => Math.abs(x(d.rho) - x(0)))
                .attr("height", y.bandwidth())
                .attr("fill", d => !d.sig ? "#6b7280" : d.rho >= 0 ? "#10b981" : "#ef4444")
                .attr("rx", 3)
                .attr("opacity", d => d.sig ? 1 : 0.5)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `<strong>${d.id}: ${d.name}</strong><br>ρ = ${d.rho.toFixed(3)}<br>p = ${d.p < 0.001 ? '<0.001' : d.p.toFixed(4)}<br>n = ${d.n}<br>${d.sig ? '✓ Significant' : '✗ Not significant'}`))
                .on("mouseout", hideTip);

            // Labels
            g.selectAll(".label").data(data).join("text")
                .attr("x", d => x(d.rho) + (d.rho >= 0 ? 6 : -6))
                .attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                .attr("text-anchor", d => d.rho >= 0 ? "start" : "end")
                .attr("fill", "#e5e7eb").attr("font-size", "10px").attr("font-family", "'JetBrains Mono', monospace")
                .text(d => d.rho.toFixed(2));
        }

        // Draw Region Chart
        function drawRegionChart() {
            const container = document.getElementById("region-chart");
            const width = Math.min(container.offsetWidth, 700), height = 220;
            const margin = { top: 10, right: 60, bottom: 20, left: 120 };

            const svg = d3.select("#region-chart").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([0, 4]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleBand().domain(regions.map(d => d.name)).range([0, height - margin.top - margin.bottom]).padding(0.35);
            const color = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, regions.length - 1]);

            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("fill", "#e5e7eb");

            g.selectAll(".bar").data(regions).join("rect")
                .attr("x", 0).attr("y", d => y(d.name))
                .attr("width", d => x(d.value)).attr("height", y.bandwidth())
                .attr("fill", (d, i) => color(regions.length - 1 - i)).attr("rx", 4)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `<strong>${d.name}</strong><br>${d.value.toFixed(2)} enquiries/student`))
                .on("mouseout", hideTip);

            g.selectAll(".label").data(regions).join("text")
                .attr("x", d => x(d.value) + 8).attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                .attr("fill", "#e5e7eb").attr("font-size", "12px").attr("font-weight", "600")
                .text(d => d.value.toFixed(2));
        }

        // Draw Operations Scatter (Attrition vs Rate)
        function drawOpsChart() {
            const container = document.getElementById("ops-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 260;
            const margin = { top: 10, right: 20, bottom: 50, left: 50 };

            const svg = d3.select("#ops-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Sim Data: Rate Logic (0 to 3)
            const data = Array.from({ length: 40 }, () => {
                const attr = Math.random() * 25 + 5;
                // Higher attrition -> slightly lower rate
                return { x: attr, y: 1.5 - (attr * 0.02) + (Math.random() * 0.5 - 0.25) };
            });

            const x = d3.scaleLinear().domain([0, 35]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleLinear().domain([0, 2.5]).range([height - margin.top - margin.bottom, 0]);

            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)).selectAll("text").attr("fill", "#9ca3af");
            g.append("text").attr("x", (width - margin.left) / 2).attr("y", height - margin.top - 10).attr("fill", "#6b7280").attr("font-size", "10px").text("Teacher Attrition (%)");

            g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").attr("fill", "#9ca3af");

            g.selectAll("circle").data(data).join("circle")
                .attr("cx", d => x(d.x)).attr("cy", d => y(d.y)).attr("r", 6)
                .attr("fill", "#ef4444").attr("opacity", 0.8)
                .attr("stroke", "#fff").attr("stroke-width", 1)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `Attrition: ${d.x.toFixed(1)}%<br>Rate: ${d.y.toFixed(2)}`))
                .on("mouseout", hideTip);
        }

        // Draw Curriculum Bar (Rate)
        function drawCurrChart() {
            const container = document.getElementById("curr-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 200;
            const margin = { top: 10, right: 20, bottom: 30, left: 100 };

            const svg = d3.select("#curr-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const data = [
                { name: "China Biling.", val: 3.85, color: "#10b981" },
                { name: "IGCSE", val: 2.76, color: "#10b981" },
                { name: "A-Levels", val: 1.55, color: "#fcd34d" },
                { name: "IB Diploma", val: 1.02, color: "#6b7280" },
                { name: "AP", val: 0.86, color: "#ef4444" }
            ];

            const x = d3.scaleLinear().domain([0, 4]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleBand().domain(data.map(d => d.name)).range([0, height - margin.top - margin.bottom]).padding(0.3);

            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("fill", "#e5e7eb");

            g.selectAll("rect").data(data).join("rect")
                .attr("x", 0).attr("y", d => y(d.name))
                .attr("width", d => x(d.val)).attr("height", y.bandwidth())
                .attr("fill", d => d.color).attr("rx", 3)
                .on("mouseover", (e, d) => showTip(e, `<strong>${d.name}</strong><br>Rate: ${d.val} enq/student`))
                .on("mouseout", hideTip);

            g.selectAll(".label").data(data).join("text")
                .attr("x", d => x(d.val) + 5).attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                .attr("fill", "#e5e7eb").attr("font-size", "10px").text(d => d.val);
        }

        // Draw Quality Scatter (NPS vs Rate - Flat)
        function drawQualityChart() {
            const container = document.getElementById("quality-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 260;
            const margin = { top: 10, right: 20, bottom: 50, left: 50 };

            const svg = d3.select("#quality-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Sim Data: Flat
            const data = Array.from({ length: 40 }, () => ({
                x: Math.random() * 80 - 10, // NPS
                y: Math.random() * 2.0 + 0.5 // Random rate
            }));

            const x = d3.scaleLinear().domain([-20, 80]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleLinear().domain([0, 3]).range([height - margin.top - margin.bottom, 0]);

            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)).selectAll("text").attr("fill", "#9ca3af");
            g.append("text").attr("x", (width - margin.left) / 2).attr("y", height - margin.top - 10).attr("fill", "#6b7280").attr("font-size", "10px").text("NPS Score");

            g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").attr("fill", "#9ca3af");

            g.selectAll("circle").data(data).join("circle")
                .attr("cx", d => x(d.x)).attr("cy", d => y(d.y)).attr("r", 6)
                .attr("fill", "#6b7280").attr("opacity", 0.6)
                .attr("stroke", "#fff").attr("stroke-width", 1)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `NPS: ${d.x.toFixed(0)}<br>Rate: ${d.y.toFixed(2)}`))
                .on("mouseout", hideTip);

            g.append("line").attr("x1", x(-20)).attr("y1", y(1.5)).attr("x2", x(80)).attr("y2", y(1.5))
                .attr("stroke", "#ef4444").attr("stroke-width", 2).attr("stroke-dasharray", "4,4");
        }

        // Draw Rejected Scatter (Age vs Rate)
        function drawRejectedChart() {
            const container = document.getElementById("rejected-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 260;
            const margin = { top: 10, right: 20, bottom: 50, left: 50 };

            const svg = d3.select("#rejected-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Sim Data: Random
            const data = Array.from({ length: 40 }, () => ({
                x: Math.random() * 50 + 2, // Age
                y: Math.random() * 2.0 + 0.5
            }));

            const x = d3.scaleLinear().domain([0, 60]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleLinear().domain([0, 3]).range([height - margin.top - margin.bottom, 0]);

            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)).selectAll("text").attr("fill", "#9ca3af");
            g.append("text").attr("x", (width - margin.left) / 2).attr("y", height - margin.top - 10).attr("fill", "#6b7280").attr("font-size", "10px").text("School Age (Years)");

            g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").attr("fill", "#9ca3af");

            g.selectAll("circle").data(data).join("circle")
                .attr("cx", d => x(d.x)).attr("cy", d => y(d.y)).attr("r", 4)
                .attr("fill", "#6b7280").attr("opacity", 0.4)
                .on("mouseover", (e, d) => showTip(e, `Age: ${d.x.toFixed(0)} yrs<br>Rate: ${d.y.toFixed(2)}`))
                .on("mouseout", hideTip);
        }

        // Initialize
        renderCards("ops-grid", "ops");
        renderCards("curr-grid", "curr");
        renderCards("market-grid", "market");
        renderCards("quality-grid", "quality");
        renderCards("rejected-grid", "rejected");
        drawEffectChart();
        drawRegionChart();

        // New Charts
        drawOpsChart();
        drawCurrChart();
        drawQualityChart();
        drawRejectedChart();

        // NYT Story Visualization (Rate Analysis Edition)
        // Clear container to prevent duplicates
        d3.select("#story-viz").html("");

        const storyData = Array.from({ length: 50 }, (_, i) => ({
            id: i,
            nps: Math.random() * 80 - 10, // -10 to 70
            fees: Math.random() * 30000 + 10000, // 10k to 40k
            rate: 0,
            region: Math.random() > 0.8 ? 'China' : 'ROW'
        })).map(d => {
            // Formula: Rate increases with Fees (0.33)
            // NPS has no effect
            // China has massive boost
            let baseRate = 0.8 + (d.fees / 40000) * 0.8; // 1.0 to 1.6
            if (d.region === 'China') baseRate += 2.0; // China Boost
            d.rate = baseRate + (Math.random() * 0.4 - 0.2);
            return d;
        });

        const storySvg = d3.select("#story-viz").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .attr("viewBox", "0 0 800 500");

        const sx = d3.scaleLinear().domain([-20, 80]).range([100, 750]);
        const sy = d3.scaleLinear().domain([0, 4.5]).range([450, 50]); // Rate 0-4.5
        const sFees = d3.scaleLinear().domain([0, 45000]).range([100, 750]);

        // Initial Axes
        storySvg.append("g").attr("class", "x-axis").attr("transform", "translate(0,450)")
            .call(d3.axisBottom(sx).ticks(5)).style("opacity", 0);
        storySvg.append("g").attr("class", "y-axis").attr("transform", "translate(100,0)")
            .call(d3.axisLeft(sy).ticks(5)).style("opacity", 0);

        storySvg.append("text").attr("class", "x-label").attr("x", 425).attr("y", 490)
            .attr("text-anchor", "middle").attr("fill", "#9ca3af").attr("font-size", "12px").text("NPS Score").style("opacity", 0);

        storySvg.append("text").attr("class", "y-label").attr("x", -250).attr("y", 30)
            .attr("transform", "rotate(-90)").attr("text-anchor", "middle").attr("fill", "#9ca3af").attr("font-size", "12px").text("Enquiries per Student (Rate)").style("opacity", 0);

        storySvg.append("text").attr("class", "intro-text").attr("x", 400).attr("y", 250)
            .attr("text-anchor", "middle").attr("fill", "#4b5563").attr("font-size", "0.85rem")
            .attr("letter-spacing", "2px").style("opacity", 1).text("SCROLL TO ANALYZE EFFICIENCY");

        function updateStory(step) {
            const t = d3.transition().duration(1000);

            if (step == 1) {
                // Intro
                storySvg.selectAll("circle").transition(t).attr("r", 0).remove();
                storySvg.selectAll(".cluster-label").remove(); // Remove labels if scrolling back
                storySvg.select(".x-axis").transition(t).style("opacity", 0);
                storySvg.select(".y-axis").transition(t).style("opacity", 0);
                storySvg.select(".x-label").transition(t).style("opacity", 0);
                storySvg.select(".y-label").transition(t).style("opacity", 0);
                storySvg.select(".intro-text").transition(t).style("opacity", 1);
            }

            if (step == 2) {
                // Assumption: Quality drives Rate
                const fakeData = storyData.map(d => ({ ...d, rate: (d.nps + 20) / 30 })); // Pos correlation
                sx.domain([-20, 80]);
                storySvg.select(".intro-text").transition(t).style("opacity", 0);
                storySvg.selectAll(".cluster-label").remove(); // Ensure labels are gone

                storySvg.select(".x-axis").transition(t).style("opacity", 1).call(d3.axisBottom(sx));
                storySvg.select(".y-axis").transition(t).style("opacity", 1);
                storySvg.select(".x-label").transition(t).style("opacity", 1).text("NPS Score (Hypothesis: Quality = Efficiency)");
                storySvg.select(".y-label").transition(t).style("opacity", 1);

                const circles = storySvg.selectAll("circle").data(fakeData, d => d.id);
                circles.enter().append("circle")
                    .attr("cx", d => sx(d.nps)).attr("cy", d => sy(d.rate))
                    .attr("r", 0).attr("fill", "#4b5563")
                    .merge(circles)
                    .on("mouseover", (e, d) => showTip(e, `<strong>Hypothetical</strong><br>NPS: ${d.nps.toFixed(0)}<br>Rate: ${d.rate.toFixed(2)}`))
                    .on("mouseout", hideTip)
                    .transition(t)
                    .attr("cx", d => sx(d.nps)).attr("cy", d => sy(d.rate))
                    .attr("r", 6).attr("fill", "#fcd34d").attr("opacity", 0.6);
            }

            if (step == 3) {
                // Reality: Zero Correlation (Color by Rate/Region to explain 'Double' bands)
                sx.domain([-20, 80]);
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sx));
                storySvg.select(".x-label").text("NPS Score (Reality: The Efficiency Gap)");

                // Add Explanatory Labels
                storySvg.selectAll(".cluster-label").remove();
                storySvg.append("text").attr("class", "cluster-label")
                    .attr("x", sx(10)).attr("y", sy(3.2)).attr("text-anchor", "start")
                    .attr("fill", "#ef4444").attr("font-size", "12px").attr("opacity", 0)
                    .text("China Bilingual (High Rate)").transition(t).attr("opacity", 1);

                storySvg.append("text").attr("class", "cluster-label")
                    .attr("x", sx(60)).attr("y", sy(1.0)).attr("text-anchor", "end")
                    .attr("fill", "#60a5fa").attr("font-size", "12px").attr("opacity", 0)
                    .text("Global Markets (Normal Rate)").transition(t).attr("opacity", 1);

                const circles = storySvg.selectAll("circle").data(storyData, d => d.id);
                circles
                    .style("cursor", "pointer")
                    .on("mouseover", (e, d) => showTip(e, `<strong>${d.region} School</strong><br>NPS: ${d.nps.toFixed(0)}<br>Rate: ${d.rate.toFixed(2)}`))
                    .on("mouseout", hideTip)
                    .transition(t)
                    .attr("cx", d => sx(d.nps)).attr("cy", d => sy(d.rate))
                    .attr("r", 8) // Larger target
                    .attr("fill", d => d.region === 'China' ? "#ef4444" : "#1e40af") // Red vs Blue
                    .attr("stroke", "#fff").attr("stroke-width", 1.5)
                    .attr("opacity", 0.9);
            }

            if (step == 4) {
                // Driver: Fees vs Rate
                storySvg.selectAll(".cluster-label").transition(t).attr("opacity", 0).remove();
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sFees).tickFormat(d => "$" + d / 1000 + "k"));
                storySvg.select(".x-label").text("Average Fees (The Efficiency Driver)");

                const circles = storySvg.selectAll("circle").data(storyData, d => d.id);
                circles
                    .on("mouseover", (e, d) => showTip(e, `<strong>School ${d.id}</strong><br>Fee: $${(d.fees / 1000).toFixed(1)}k<br>Rate: ${d.rate.toFixed(2)}`))
                    .on("mouseout", hideTip)
                    .transition(t)
                    .attr("cx", d => sFees(d.fees)) // X is Fees
                    .attr("cy", d => sy(d.rate))
                    .attr("r", d => d.fees / 3000 + 2)
                    .attr("fill", "#c9a227")
                    .attr("stroke", "#fff").attr("stroke-width", 1)
                    .attr("opacity", 0.8);
            }

            if (step == 5) {
                // Analysis: China Highlights (Zoom in?)
                // Actually keep Step 4 view but highlight.
                // Or back to NPS?
                // Let's go back to NPS to show the clusters again but this time we emphasize them

                sx.domain([-20, 80]);
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sx));
                storySvg.select(".x-label").text("NPS Score (Regional Clustering)");

                storySvg.selectAll(".cluster-label").remove(); // Remove previous labels
                storySvg.append("text").attr("class", "cluster-label")
                    .attr("x", sx(20)).attr("y", sy(3.5)).attr("text-anchor", "middle")
                    .attr("fill", "#ef4444").attr("font-size", "12px").attr("opacity", 0)
                    .text("China Bilingual Cluster (High Rate)").transition(t).attr("opacity", 1);

                storySvg.append("text").attr("class", "cluster-label")
                    .attr("x", sx(50)).attr("y", sy(1.2)).attr("text-anchor", "middle")
                    .attr("fill", "#6b7280").attr("font-size", "12px").attr("opacity", 0)
                    .text("Global Average (~1.0)").transition(t).attr("opacity", 1);

                const circles = storySvg.selectAll("circle").data(storyData, d => d.id);
                circles
                    .style("cursor", "pointer")
                    .on("mouseover", (e, d) => showTip(e, `<strong>${d.region}</strong><br>Rate: ${d.rate.toFixed(2)}`))
                    .on("mouseout", hideTip)
                    .transition(t)
                    .attr("cx", d => sx(d.nps))
                    .attr("cy", d => sy(d.rate))
                    .attr("r", d => d.region === 'China' ? 10 : 4)
                    .attr("fill", d => d.region === 'China' ? "#ef4444" : "#1f2937")
                    .attr("stroke", d => d.region === 'China' ? "#fff" : "none")
                    .attr("stroke-width", 2)
                    .attr("opacity", d => d.region === 'China' ? 1 : 0.2);
            }
        }

        // Observer
        const steps = document.querySelectorAll('.step');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const step = entry.target.getAttribute('data-step');
                    updateStory(step);
                    steps.forEach(s => s.classList.remove('active'));
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.5 }); // Trigger when 50% visible
        steps.forEach(step => observer.observe(step));

    </script>
</body>

</html>