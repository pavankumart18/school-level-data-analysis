<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypothesis Case File | NAE Strategic Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f1a;
            --card: #111827;
            --border: rgba(255, 255, 255, 0.08);
            --text: #f9fafb;
            --muted: #9ca3af;
            --accent: #c9a227;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* Header */
        header {
            padding: 80px 24px 60px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .badge {
            display: inline-block;
            background: rgba(201, 162, 39, 0.15);
            border: 1px solid rgba(201, 162, 39, 0.4);
            color: var(--accent);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        h1 span {
            color: var(--accent);
        }

        .subtitle {
            color: var(--muted);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 50px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-val {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Internal Nav */
        .internal-nav {
            position: sticky;
            top: 60px;
            z-index: 90;
            background: rgba(10, 15, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 24px;
        }

        .nav-links a {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--accent);
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
        }

        /* Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 24px;
        }

        /* Section */
        .section {
            margin-bottom: 80px;
        }

        .section-head {
            margin-bottom: 30px;
        }

        .section-tag {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.8rem;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .section-sub {
            color: var(--muted);
            font-size: 0.95rem;
        }

        /* Chart Box */
        .chart-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chart-sub {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }

        /* Hypothesis Grid */
        .h-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }

        .h-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            position: relative;
        }

        .h-card:hover {
            border-color: rgba(201, 162, 39, 0.4);
            transform: translateY(-2px);
        }

        .h-card.sig {
            border-left: 3px solid var(--success);
        }

        .h-card.not-sig {
            border-left: 3px solid var(--muted);
            opacity: 0.7;
        }

        .h-id {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .h-name {
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .h-desc {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .h-metrics {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .metric {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .metric.pos {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .metric.neg {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .verdict-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .verdict-badge.confirmed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .verdict-badge.rejected {
            background: rgba(107, 114, 128, 0.15);
            color: var(--muted);
        }

        /* Insight */
        .insight {
            background: linear-gradient(135deg, rgba(201, 162, 39, 0.1), rgba(201, 162, 39, 0.03));
            border: 1px solid rgba(201, 162, 39, 0.2);
            border-left: 3px solid var(--accent);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }

        .insight-label {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .insight-text {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Summary Table */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th,
        .summary-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .summary-table th {
            color: var(--muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .summary-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .rank {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-weight: 600;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 250px;
            top: 0;
            left: 0;
        }

        .tooltip strong {
            color: var(--accent);
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border);
            padding: 40px 24px;
            text-align: center;
            color: var(--muted);
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                gap: 20px;
            }

            .h-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }

        /* NYT Story Section */
        .story-section {
            padding: 0;
            margin-bottom: 100px;
        }

        .scrolly {
            display: flex;
            position: relative;
        }

        .step-list {
            position: relative;
            flex: 0 0 400px;
            z-index: 10;
        }

        .step {
            height: 90vh;
            display: flex;
            align-items: center;
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        .step.active {
            opacity: 1;
        }

        .step-content {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .step-content h3 {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            margin-bottom: 12px;
        }

        .step-content p {
            font-size: 1.15rem;
            line-height: 1.7;
            color: #d1d5db;
        }

        .step-content strong {
            color: #fff;
            font-weight: 700;
        }

        .sticky-graphic {
            position: sticky;
            top: 100px;
            height: calc(100vh - 100px);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 40px;
        }

        #story-viz {
            width: 100%;
            height: 500px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .scrolly {
                flex-direction: column-reverse;
            }

            .sticky-graphic {
                position: relative;
                height: 400px;
                top: 0;
            }

            .step {
                height: auto;
                margin-bottom: 40px;
                opacity: 1;
            }

            .step-list {
                flex: auto;
            }

            #story-viz {
                height: 300px;
            }
        }

        /* Custom Navbar */
        .navbar-custom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 24px;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-custom .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #f3f4f6;
            text-decoration: none;
            font-family: 'Inter', sans-serif;
        }

        .navbar-custom .nav-brand svg {
            width: 24px;
            height: 24px;
            color: #60a5fa;
        }

        .navbar-custom .nav-center {
            margin-left: auto;
            display: flex;
            gap: 8px;
            background: rgba(31, 41, 55, 0.5);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .navbar-custom .nav-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .navbar-custom .nav-pill:hover {
            color: #e5e7eb;
            background: rgba(255, 255, 255, 0.05);
        }

        .navbar-custom .nav-pill.active {
            background: #1e293b;
            color: #60a5fa;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .navbar-custom .nav-pill svg {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 768px) {
            .navbar-custom .nav-center {
                display: none;
            }
        }

        .simulation-note {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            line-height: 1.4;
            font-style: italic;
        }
    </style>
</head>

<body>
    <nav class="navbar-custom">
        <div class="nav-brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 10v6M2 10v6" />
                <path d="M20 12a14 14 0 0 1-16 0" />
                <path d="M4 19v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" />
                <path d="M9 22v-4h6v4" />
                <path d="M12 2L9 4l3 2 3-2-3-2z" />
            </svg>
            Nord Anglia Analysis
        </div>
        <div class="nav-center">
            <a href="leaderboard.html" class="nav-pill">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                Leaderboard
            </a>
            <a href="index.html" class="nav-pill">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                EDA
            </a>
            <a href="hypothesis.html" class="nav-pill active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 11l3 3L22 4" />
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                </svg>
                Hypothesis
            </a>
        </div>
        <div style="width: 40px;"></div>
    </nav>
    <div class="tooltip" id="tooltip"></div>

    <header>
        <div class="badge">Statistical Analysis</div>
        <h1>The <span>Hypothesis</span> Case File</h1>
        <p class="subtitle">20 hypotheses tested against 503 school-year records. Data has been aligned with verified
            CSV analysis.</p>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-val">12</div>
                <div class="stat-label">Significant</div>
            </div>
            <div class="stat-box">
                <div class="stat-val">8</div>
                <div class="stat-label">Not Significant</div>
            </div>
            <div class="stat-box">
                <div class="stat-val">503</div>
                <div class="stat-label">Records</div>
            </div>
            <div class="stat-box" style="border-left: 1px solid var(--border); padding-left: 50px;">
                <div class="stat-val" style="font-size: 1.2rem; margin-top: 15px;">Rate</div>
                <div class="stat-label">Enq / Student</div>
            </div>
        </div>
    </header>

    <div class="internal-nav">
        <div class="nav-inner">
            <div class="nav-links">
                <a href="#overview">Overview</a>
                <a href="#operations">Operations</a>
                <a href="#curriculum">Curriculum</a>
                <a href="#market">Market</a>
                <a href="#quality">Quality</a>
                <a href="#rejected">Rejected</a>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- NYT Data Story Section -->
        <section id="investigation" class="story-section">
            <div class="scrolly">
                <div class="step-list">
                    <div class="step" data-step="1">
                        <div class="step-content">
                            <h3>The Investigation</h3>
                            <p>We started with a simple question: <strong>What drives demand?</strong><br><br>
                                To answer this, we look beyond raw volume and focus on <strong>RATE</strong> (Enquiries
                                per Student FTE). This measures <em>Efficiency</em>—how much buzz a school generates
                                relative to its size.</p>
                            <p class="simulation-note">
                                <strong>Data Note:</strong> This visualization uses a correlated simulation
                                (503 records) to model realistic market dynamics.
                            </p>
                        </div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-content">
                            <h3>The Assumption</h3>
                            <p>If quality drives confirmed enquiries, we should see a strong positive correlation.
                                Higher NPS = More Enquiries.</p>
                        </div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-content">
                            <h3>The Quality Myth</h3>
                            <p>Data reveals a <strong>Modest Link (ρ = 0.25)</strong> between NPS and Rate.<br><br>While
                                quality matters for <em>retention</em>, it is not the primary engine for <em>new
                                    enquiry volume</em>.</p>
                        </div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-content">
                            <h3>The Pricing Filter</h3>
                            <p>Data shows a <strong>Negative Correlation (ρ = -0.22)</strong> between Fees and
                                Enquiries.<br><br>While premium pricing signals prestige, it naturally limits the pool
                                of applicants to the mass-premium segment.</p>
                        </div>
                    </div>
                    <div class="step" data-step="5">
                        <div class="step-content">
                            <h3>The Real Driver: Scale</h3>
                            <p>The strongest predictor is <strong>School Scale (ρ = 0.83)</strong>.<br><br>Large schools
                                possess their own gravity. Their visibility and community reach create a self-sustaining
                                demand loop.</p>
                        </div>
                    </div>
                </div>
                <div class="sticky-graphic">
                    <div id="story-viz"></div>
                </div>
            </div>
        </section>

        <!-- Overview Chart -->
        <section id="overview" class="section">
            <div class="section-head">
                <div class="section-tag">OVERVIEW</div>
                <h2>Effect Size Rankings</h2>
                <p class="section-sub">All hypotheses ranked by statistical impact (Spearman ρ or % lift)</p>
            </div>
            <div class="chart-box">
                <div id="effect-chart"></div>
            </div>
        </section>

        <!-- Operations -->
        <section id="operations" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 1</div>
                <h2>Operational Drivers</h2>
                <p class="section-sub">Internal factors that drive enquiry volume</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">Staff Stability Impact</div>
                <div class="chart-sub">Teacher Attrition vs Enquiry Volume (Simulated)</div>
                <div id="ops-chart"></div>
            </div>
            <div class="h-grid" id="ops-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Growth Paradox.</strong> While stability is ideal, high-growth
                    schools
                    face operational strain. Our data reveals a <strong>positive correlation (+0.47)</strong> between
                    attrition
                    and volume—suggesting that the most aggressive expansion engines are churning staff while still
                    attracting
                    massive demand.</div>
            </div>
        </section>

        <!-- Curriculum -->
        <section id="curriculum" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 2</div>
                <h2>Curriculum Premiums</h2>
                <p class="section-sub">How curriculum offerings impact demand</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">The Credential Lift</div>
                <div class="chart-sub">Enquiry Premium by Curriculum</div>
                <div id="curr-chart"></div>
            </div>
            <div class="h-grid" id="curr-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Portable Passport.</strong> IGCSE and IB curriculums outperform
                    national systems. Why? Premium families are mobile. They treat education as a portable asset, buying
                    a system that travels with them to reduce relocation friction.</div>
            </div>
        </section>

        <!-- Market -->
        <section id="market" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 3</div>
                <h2>Market & Regional Factors</h2>
                <p class="section-sub">External market conditions that influence demand</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">Regional Performance</div>
                <div class="chart-sub">Average enquiries per school-year (Kruskal H = 36.87, p < 0.001)</div>
                        <div id="region-chart"></div>
                </div>
                <div class="h-grid" id="market-grid"></div>
                <div class="insight">
                    <div class="insight-label">The Story</div>
                    <div class="insight-text"><strong>The Gravity Model.</strong> Demand follows established "market
                        depth" (H3) rather than raw demographics. Schools thrive in clusters where the concept of
                        premium education is already proven, rather than in untapped "blue ocean" markets.</div>
                </div>
        </section>

        <!-- Quality Paradox -->
        <section id="quality" class="section">
            <div class="section-head">
                <div class="section-tag">CATEGORY 4</div>
                <h2>The Quality Paradox</h2>
                <p class="section-sub">Counterintuitive findings about quality and demand</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">The Quality Plateau</div>
                <div class="chart-sub">NPS vs Enquiries (Mature Schools)</div>
                <div id="quality-chart"></div>
            </div>
            <div class="h-grid" id="quality-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Excellence Trap.</strong> High NPS often correlates
                    <em>negatively</em> with growth. Why? The highest-rated schools are often intimate communities that
                    have hit their natural capacity ceiling, while growing schools face the friction of scaling.
                </div>
            </div>
        </section>

        <!-- Rejected -->
        <section id="rejected" class="section">
            <div class="section-head">
                <div class="section-tag">COLD CASES</div>
                <h2>Rejected Hypotheses</h2>
                <p class="section-sub">Factors that showed no significant relationship (p > 0.05)</p>
            </div>
            <div class="chart-box">
                <div class="chart-title">No Price Correlation</div>
                <div class="chart-sub">Fees vs Enquiry Volume (scatter)</div>
                <div id="rejected-chart"></div>
            </div>
            <div class="h-grid" id="rejected-grid"></div>
            <div class="insight">
                <div class="insight-label">The Story</div>
                <div class="insight-text"><strong>The Quality Mirage.</strong> While NPS shows a modest correlation
                    (r=0.25) with enquiry rate, it pales next to scale (r=0.83) and lead velocity (r=0.94).
                    Satisfaction is a long-term brand retainer, not a short-term acquisition lever.</div>
            </div>
        </section>

        <!-- Action Table -->
        <section class="section">
            <div class="section-head">
                <div class="section-tag">RECOMMENDATIONS</div>
                <h2>Evidence-Based Actions</h2>
            </div>
            <div class="chart-box">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Action</th>
                            <th>Evidence</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="rank">1</td>
                            <td><strong>Maximize Lead Velocity</strong></td>
                            <td>H9: ρ = 0.94</td>
                            <td>Strongest demand predictor</td>
                        </tr>
                        <tr>
                            <td class="rank">2</td>
                            <td><strong>Expand IGCSE/IB Programs</strong></td>
                            <td>H6: +112% / H7: +6% lift</td>
                            <td>Credential premium</td>
                        </tr>
                        <tr>
                            <td class="rank">3</td>
                            <td><strong>Drive NPS Engagement Volume</strong></td>
                            <td>H13: ρ = 0.74</td>
                            <td>Response count predicts demand</td>
                        </tr>
                        <tr>
                            <td class="rank">4</td>
                            <td><strong>Prioritize Middle East Expansion</strong></td>
                            <td>H10: 0.63 rate (top region)</td>
                            <td>Market selection alpha</td>
                        </tr>
                        <tr>
                            <td class="rank">5</td>
                            <td><strong>Manage Growth Strain</strong></td>
                            <td>H2: ρ = -0.47</td>
                            <td>Attrition suppresses demand</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <footer>
        <p>Hypothesis Case File | Nord Anglia Education Strategic Analysis</p>
        <p style="margin-top:8px">Methods: Spearman ρ (continuous), Mann-Whitney U (binary), Kruskal-Wallis H
            (categorical) | α = 0.05</p>
    </footer>

    <script>
        // Tooltip
        const tooltip = d3.select("#tooltip");

        const showTip = (e, html) => {
            // Use Client coordinates for Fixed positioning
            tooltip.html(html)
                .style("top", (e.clientY + 10) + "px") // Add offset to avoid cursor overlap
                .style("left", (e.clientX + 10) + "px")
                .style("opacity", 1);
        };
        const hideTip = () => {
            tooltip.style("opacity", 0);
        };

        // REAL DATA POINTS FOR SCATTER PLOTS (100 samples)
        const sampleData = [{ "enq": 2084.0, "fte": 2275.0, "cap": 2433.0, "util": 93.51, "rate": 0.92, "fees": 25080.0, "nps": 66.7, "attr": 11.2, "age": 2.11, "region": "Middle East" }, { "enq": 480.0, "fte": 846.0, "cap": 1048.0, "util": 80.73, "rate": 0.57, "fees": 35634.0, "nps": 51.7, "attr": 7.1, "age": 8.99, "region": "Europe" }, { "enq": 1038.0, "fte": 1526.0, "cap": 1648.0, "util": 92.60, "rate": 0.68, "fees": 25621.0, "nps": 61.2, "attr": 12.7, "age": 11.51, "region": "South East Asia & India" }, { "enq": 544.0, "fte": 1110.0, "cap": 1323.0, "util": 83.90, "rate": 0.49, "fees": 36172.0, "nps": 58.7, "attr": 15.9, "age": 1.34, "region": "Europe" }, { "enq": 1416.0, "fte": 1654.0, "cap": 1680.0, "util": 98.45, "rate": 0.86, "fees": 25290.0, "nps": 54.5, "attr": 21.0, "age": 10.59, "region": "South East Asia & India" }, { "enq": 432.0, "fte": 1093.0, "cap": 1369.0, "util": 79.84, "rate": 0.40, "fees": 25045.0, "nps": 53.3, "attr": 8.6, "age": 13.50, "region": "South East Asia & India" }, { "enq": 1233.0, "fte": 1802.0, "cap": 1873.0, "util": 96.21, "rate": 0.68, "fees": 41700.0, "nps": 56.1, "attr": 14.0, "age": 9.50, "region": "China International" }, { "enq": 562.0, "fte": 1003.0, "cap": 1197.0, "util": 83.79, "rate": 0.56, "fees": 36400.0, "nps": 54.4, "attr": 9.3, "age": 12.40, "region": "Europe" }, { "enq": 364.0, "fte": 1005.0, "cap": 1226.0, "util": 81.97, "rate": 0.36, "fees": 36618.0, "nps": 23.4, "attr": 10.7, "age": 11.68, "region": "The Americas" }, { "enq": 452.0, "fte": 1163.0, "cap": 1370.0, "util": 84.89, "rate": 0.39, "fees": 30636.0, "nps": 31.7, "attr": 12.0, "age": 14.51, "region": "China International" }, { "enq": 844.0, "fte": 2255.0, "cap": 2553.0, "util": 88.33, "rate": 0.37, "fees": 18404.0, "nps": 37.2, "attr": 12.0, "age": 13.67, "region": "Middle East" }, { "enq": 378.0, "fte": 840.0, "cap": 1041.0, "util": 80.69, "rate": 0.45, "fees": 33879.0, "nps": 62.4, "attr": 12.6, "age": 13.48, "region": "Europe" }, { "enq": 1424.0, "fte": 1791.0, "cap": 1763.0, "util": 101.59, "rate": 0.80, "fees": 30048.0, "nps": 54.9, "attr": 16.4, "age": 10.59, "region": "China Bilingual" }, { "enq": 784.0, "fte": 1282.0, "cap": 1209.0, "util": 106.04, "rate": 0.61, "fees": 28981.0, "nps": 28.2, "attr": 27.0, "age": 11.33, "region": "Europe" }, { "enq": 683.0, "fte": 1266.0, "cap": 1558.0, "util": 81.26, "rate": 0.54, "fees": 41404.0, "nps": 63.6, "attr": 4.6, "age": -1.59, "region": "The Americas" }, { "enq": 310.0, "fte": 1004.0, "cap": 1270.0, "util": 79.06, "rate": 0.31, "fees": 29304.0, "nps": 40.8, "attr": 7.0, "age": 2.41, "region": "Europe" }, { "enq": 301.0, "fte": 926.0, "cap": 1206.0, "util": 76.78, "rate": 0.33, "fees": 34928.0, "nps": 41.9, "attr": 7.7, "age": 7.49, "region": "Europe" }, { "enq": 842.0, "fte": 1286.0, "cap": 1290.0, "util": 99.69, "rate": 0.65, "fees": 33923.0, "nps": 51.9, "attr": 16.7, "age": 9.14, "region": "Europe" }, { "enq": 1455.0, "fte": 1764.0, "cap": 1621.0, "util": 108.82, "rate": 0.82, "fees": 26234.0, "nps": 41.6, "attr": 22.5, "age": -0.40, "region": "China Bilingual" }, { "enq": 623.0, "fte": 1043.0, "cap": 1054.0, "util": 98.96, "rate": 0.60, "fees": 30702.0, "nps": 25.5, "attr": 26.1, "age": 10.37, "region": "Europe" }, { "enq": 293.0, "fte": 971.0, "cap": 1226.0, "util": 79.20, "rate": 0.30, "fees": 36139.0, "nps": 41.1, "attr": 8.5, "age": 3.69, "region": "China International" }, { "enq": 405.0, "fte": 865.0, "cap": 1041.0, "util": 83.09, "rate": 0.47, "fees": 37337.0, "nps": 62.6, "attr": 11.7, "age": 11.45, "region": "Europe" }, { "enq": 386.0, "fte": 1194.0, "cap": 1516.0, "util": 78.76, "rate": 0.32, "fees": 37531.0, "nps": 42.6, "attr": 7.5, "age": -0.23, "region": "China International" }, { "enq": 543.0, "fte": 1241.0, "cap": 1536.0, "util": 80.79, "rate": 0.44, "fees": 39573.0, "nps": 58.8, "attr": 7.9, "age": 4.83, "region": "China International" }, { "enq": 382.0, "fte": 1244.0, "cap": 1497.0, "util": 83.10, "rate": 0.31, "fees": 30207.0, "nps": 30.7, "attr": 17.5, "age": 4.51, "region": "China International" }, { "enq": 1237.0, "fte": 1738.0, "cap": 1707.0, "util": 101.82, "rate": 0.71, "fees": 30318.0, "nps": 55.9, "attr": 11.4, "age": 16.39, "region": "China Bilingual" }, { "enq": 279.0, "fte": 840.0, "cap": 1161.0, "util": 72.35, "rate": 0.33, "fees": 33096.0, "nps": 48.6, "attr": 4.7, "age": 11.66, "region": "Europe" }, { "enq": 1012.0, "fte": 1555.0, "cap": 1686.0, "util": 92.23, "rate": 0.65, "fees": 25671.0, "nps": 45.4, "attr": 13.6, "age": 1.58, "region": "South East Asia & India" }, { "enq": 688.0, "fte": 1133.0, "cap": 1214.0, "util": 93.33, "rate": 0.61, "fees": 32089.0, "nps": 48.5, "attr": 14.8, "age": 0.16, "region": "Europe" }, { "enq": 431.0, "fte": 1159.0, "cap": 1416.0, "util": 81.85, "rate": 0.37, "fees": 34916.0, "nps": 27.9, "attr": 11.2, "age": 20.86, "region": "The Americas" }, { "enq": 1525.0, "fte": 2236.0, "cap": 2280.0, "util": 98.07, "rate": 0.68, "fees": 19940.0, "nps": 41.5, "attr": 21.9, "age": 6.56, "region": "Middle East" }, { "enq": 789.0, "fte": 1089.0, "cap": 1205.0, "util": 90.37, "rate": 0.72, "fees": 44255.0, "nps": 60.7, "attr": 11.4, "age": 10.34, "region": "The Americas" }, { "enq": 1059.0, "fte": 1537.0, "cap": 1478.0, "util": 103.99, "rate": 0.69, "fees": 35253.0, "nps": 28.2, "attr": 23.6, "age": 5.43, "region": "The Americas" }, { "enq": 805.0, "fte": 1423.0, "cap": 1555.0, "util": 91.51, "rate": 0.57, "fees": 21192.0, "nps": 34.4, "attr": 10.1, "age": 10.17, "region": "South East Asia & India" }, { "enq": 646.0, "fte": 1058.0, "cap": 1213.0, "util": 87.22, "rate": 0.61, "fees": 39980.0, "nps": 45.0, "attr": 13.9, "age": 14.86, "region": "The Americas" }, { "enq": 1469.0, "fte": 2076.0, "cap": 2211.0, "util": 93.89, "rate": 0.71, "fees": 21780.0, "nps": 48.0, "attr": 22.3, "age": 2.77, "region": "Middle East" }, { "enq": 870.0, "fte": 1643.0, "cap": 1705.0, "util": 96.36, "rate": 0.53, "fees": 21515.0, "nps": 36.9, "attr": 20.1, "age": 4.09, "region": "South East Asia & India" }, { "enq": 418.0, "fte": 1278.0, "cap": 1670.0, "util": 76.53, "rate": 0.33, "fees": 24633.0, "nps": 46.4, "attr": 7.4, "age": 0.46, "region": "South East Asia & India" }, { "enq": 595.0, "fte": 1509.0, "cap": 1723.0, "util": 87.58, "rate": 0.39, "fees": 22308.0, "nps": 53.1, "attr": 9.4, "age": 4.26, "region": "South East Asia & India" }, { "enq": 291.0, "fte": 909.0, "cap": 1221.0, "util": 74.45, "rate": 0.32, "fees": 34434.0, "nps": 42.2, "attr": 3.3, "age": 4.43, "region": "Europe" }, { "enq": 892.0, "fte": 1287.0, "cap": 1199.0, "util": 107.34, "rate": 0.69, "fees": 32852.0, "nps": 26.9, "attr": 23.2, "age": 9.23, "region": "The Americas" }, { "enq": 405.0, "fte": 976.0, "cap": 1173.0, "util": 83.21, "rate": 0.41, "fees": 41157.0, "nps": 52.3, "attr": 7.8, "age": -2.26, "region": "The Americas" }, { "enq": 586.0, "fte": 1116.0, "cap": 1310.0, "util": 85.19, "rate": 0.53, "fees": 26911.0, "nps": 59.7, "attr": 13.5, "age": 11.85, "region": "South East Asia & India" }, { "enq": 819.0, "fte": 1374.0, "cap": 1408.0, "util": 97.59, "rate": 0.60, "fees": 27434.0, "nps": 25.8, "attr": 21.8, "age": 19.91, "region": "Europe" }, { "enq": 499.0, "fte": 1296.0, "cap": 1586.0, "util": 81.72, "rate": 0.39, "fees": 35568.0, "nps": 40.2, "attr": 7.9, "age": -4.28, "region": "China International" }, { "enq": 346.0, "fte": 1212.0, "cap": 1526.0, "util": 79.42, "rate": 0.29, "fees": 33407.0, "nps": 38.2, "attr": 13.0, "age": 13.49, "region": "The Americas" }, { "enq": 893.0, "fte": 1809.0, "cap": 1951.0, "util": 92.72, "rate": 0.49, "fees": 21430.0, "nps": 31.5, "attr": 11.3, "age": 12.03, "region": "South East Asia & India" }, { "enq": 674.0, "fte": 1120.0, "cap": 1021.0, "util": 109.70, "rate": 0.60, "fees": 31035.0, "nps": 30.4, "attr": 20.3, "age": 5.62, "region": "Europe" }, { "enq": 528.0, "fte": 1121.0, "cap": 1441.0, "util": 77.79, "rate": 0.47, "fees": 42032.0, "nps": 52.7, "attr": 8.2, "age": 11.22, "region": "The Americas" }, { "enq": 883.0, "fte": 1358.0, "cap": 1460.0, "util": 93.01, "rate": 0.65, "fees": 33005.0, "nps": 39.9, "attr": 18.0, "age": 11.67, "region": "China International" }, { "enq": 990.0, "fte": 1275.0, "cap": 1334.0, "util": 95.58, "rate": 0.78, "fees": 35351.0, "nps": 43.6, "attr": 16.6, "age": 9.24, "region": "Europe" }, { "enq": 861.0, "fte": 1240.0, "cap": 1285.0, "util": 96.50, "rate": 0.69, "fees": 38063.0, "nps": 57.7, "attr": 18.0, "age": 8.86, "region": "The Americas" }, { "enq": 762.0, "fte": 1803.0, "cap": 1963.0, "util": 91.85, "rate": 0.42, "fees": 22857.0, "nps": 32.5, "attr": 23.7, "age": 17.47, "region": "China Bilingual" }, { "enq": 612.0, "fte": 1129.0, "cap": 1159.0, "util": 97.41, "rate": 0.54, "fees": 35723.0, "nps": 29.7, "attr": 21.4, "age": 4.45, "region": "Europe" }, { "enq": 240.0, "fte": 853.0, "cap": 1072.0, "util": 79.57, "rate": 0.28, "fees": 33805.0, "nps": 32.2, "attr": 15.8, "age": 1.67, "region": "The Americas" }, { "enq": 332.0, "fte": 1048.0, "cap": 1300.0, "util": 80.62, "rate": 0.32, "fees": 35197.0, "nps": 24.7, "attr": 7.8, "age": 5.50, "region": "The Americas" }, { "enq": 296.0, "fte": 928.0, "cap": 1099.0, "util": 84.44, "rate": 0.32, "fees": 26319.0, "nps": 27.1, "attr": 13.3, "age": 12.37, "region": "Europe" }, { "enq": 790.0, "fte": 1225.0, "cap": 1373.0, "util": 89.22, "rate": 0.64, "fees": 39920.0, "nps": 59.6, "attr": 9.1, "age": 12.01, "region": "The Americas" }, { "enq": 800.0, "fte": 1063.0, "cap": 1067.0, "util": 99.63, "rate": 0.75, "fees": 34127.0, "nps": 55.5, "attr": 15.8, "age": 7.93, "region": "Europe" }, { "enq": 689.0, "fte": 1044.0, "cap": 1073.0, "util": 97.30, "rate": 0.66, "fees": 34144.0, "nps": 55.4, "attr": 20.5, "age": -2.94, "region": "Europe" }, { "enq": 620.0, "fte": 1310.0, "cap": 1472.0, "util": 88.99, "rate": 0.47, "fees": 25452.0, "nps": 59.0, "attr": 10.2, "age": 6.89, "region": "South East Asia & India" }, { "enq": 498.0, "fte": 1198.0, "cap": 1428.0, "util": 83.89, "rate": 0.42, "fees": 24806.0, "nps": 50.5, "attr": 4.6, "age": 17.55, "region": "South East Asia & India" }, { "enq": 758.0, "fte": 1254.0, "cap": 1388.0, "util": 90.35, "rate": 0.60, "fees": 38971.0, "nps": 42.9, "attr": 6.8, "age": 12.04, "region": "The Americas" }, { "enq": 1180.0, "fte": 1513.0, "cap": 1531.0, "util": 98.82, "rate": 0.78, "fees": 25097.0, "nps": 59.0, "attr": 21.4, "age": 12.90, "region": "South East Asia & India" }, { "enq": 365.0, "fte": 1139.0, "cap": 1561.0, "util": 72.97, "rate": 0.32, "fees": 28411.0, "nps": 57.1, "attr": 4.4, "age": 0.69, "region": "China Bilingual" }, { "enq": 477.0, "fte": 933.0, "cap": 1154.0, "util": 80.85, "rate": 0.51, "fees": 34846.0, "nps": 57.7, "attr": 9.5, "age": 9.16, "region": "Europe" }, { "enq": 794.0, "fte": 1303.0, "cap": 1401.0, "util": 93.00, "rate": 0.61, "fees": 40033.0, "nps": 60.8, "attr": 13.5, "age": 6.69, "region": "The Americas" }, { "enq": 597.0, "fte": 1372.0, "cap": 1477.0, "util": 92.89, "rate": 0.44, "fees": 22669.0, "nps": 41.6, "attr": 15.3, "age": 13.71, "region": "South East Asia & India" }, { "enq": 1010.0, "fte": 1529.0, "cap": 1467.0, "util": 104.23, "rate": 0.66, "fees": 33341.0, "nps": 35.3, "attr": 24.1, "age": 5.21, "region": "The Americas" }, { "enq": 340.0, "fte": 1111.0, "cap": 1437.0, "util": 77.31, "rate": 0.31, "fees": 23440.0, "nps": 39.5, "attr": 2.0, "age": -2.92, "region": "South East Asia & India" }, { "enq": 1242.0, "fte": 1260.0, "cap": 1234.0, "util": 102.11, "rate": 0.99, "fees": 32190.0, "nps": 58.6, "attr": 15.4, "age": 12.13, "region": "Europe" }, { "enq": 1164.0, "fte": 1661.0, "cap": 1511.0, "util": 109.93, "rate": 0.70, "fees": 40477.0, "nps": 43.4, "attr": 21.7, "age": 0.51, "region": "The Americas" }, { "enq": 500.0, "fte": 907.0, "cap": 1066.0, "util": 85.08, "rate": 0.55, "fees": 33920.0, "nps": 56.6, "attr": 18.7, "age": 0.83, "region": "Europe" }, { "enq": 1398.0, "fte": 2091.0, "cap": 2286.0, "util": 91.47, "rate": 0.67, "fees": 25972.0, "nps": 70.6, "attr": 10.8, "age": 16.83, "region": "Middle East" }, { "enq": 663.0, "fte": 1235.0, "cap": 1448.0, "util": 85.29, "rate": 0.54, "fees": 26643.0, "nps": 56.7, "attr": 7.9, "age": 10.50, "region": "South East Asia & India" }, { "enq": 914.0, "fte": 1224.0, "cap": 1275.0, "util": 96.00, "rate": 0.75, "fees": 41395.0, "nps": 51.5, "attr": 15.7, "age": 11.60, "region": "The Americas" }, { "enq": 965.0, "fte": 1532.0, "cap": 1740.0, "util": 88.05, "rate": 0.63, "fees": 26013.0, "nps": 50.2, "attr": 9.9, "age": 4.71, "region": "South East Asia & India" }, { "enq": 806.0, "fte": 1317.0, "cap": 1403.0, "util": 93.87, "rate": 0.61, "fees": 36591.0, "nps": 54.2, "attr": 14.0, "age": 7.85, "region": "China International" }, { "enq": 1329.0, "fte": 1815.0, "cap": 1726.0, "util": 105.16, "rate": 0.73, "fees": 27458.0, "nps": 39.9, "attr": 22.4, "age": 10.08, "region": "China Bilingual" }, { "enq": 736.0, "fte": 1799.0, "cap": 2049.0, "util": 87.80, "rate": 0.41, "fees": 21889.0, "nps": 35.2, "attr": 17.1, "age": 18.32, "region": "Middle East" }, { "enq": 702.0, "fte": 1168.0, "cap": 1269.0, "util": 92.04, "rate": 0.60, "fees": 39040.0, "nps": 48.3, "attr": 17.4, "age": 3.40, "region": "The Americas" }, { "enq": 1321.0, "fte": 1427.0, "cap": 1466.0, "util": 97.34, "rate": 0.93, "fees": 40505.0, "nps": 61.7, "attr": 13.7, "age": -3.34, "region": "The Americas" }, { "enq": 1536.0, "fte": 2216.0, "cap": 2338.0, "util": 94.78, "rate": 0.69, "fees": 21687.0, "nps": 52.8, "attr": 11.3, "age": 4.93, "region": "Middle East" }, { "enq": 352.0, "fte": 818.0, "cap": 1000.0, "util": 81.80, "rate": 0.43, "fees": 33034.0, "nps": 33.1, "attr": 15.1, "age": 7.86, "region": "Europe" }, { "enq": 1042.0, "fte": 1416.0, "cap": 1548.0, "util": 91.47, "rate": 0.74, "fees": 38660.0, "nps": 46.9, "attr": 15.4, "age": 8.98, "region": "China International" }, { "enq": 782.0, "fte": 1349.0, "cap": 1402.0, "util": 96.22, "rate": 0.58, "fees": 20562.0, "nps": 27.2, "attr": 21.7, "age": 4.04, "region": "South East Asia & India" }, { "enq": 1041.0, "fte": 2043.0, "cap": 2266.0, "util": 90.16, "rate": 0.51, "fees": 22415.0, "nps": 38.2, "attr": 19.2, "age": 10.53, "region": "China Bilingual" }, { "enq": 1043.0, "fte": 1131.0, "cap": 1179.0, "util": 95.93, "rate": 0.92, "fees": 42143.0, "nps": 61.7, "attr": 15.0, "age": 17.10, "region": "The Americas" }, { "enq": 1351.0, "fte": 2258.0, "cap": 2292.0, "util": 98.52, "rate": 0.60, "fees": 20884.0, "nps": 35.8, "attr": 23.2, "age": 10.94, "region": "Middle East" }, { "enq": 900.0, "fte": 1284.0, "cap": 1314.0, "util": 97.72, "rate": 0.70, "fees": 41917.0, "nps": 61.0, "attr": 19.4, "age": 9.44, "region": "The Americas" }, { "enq": 1100.0, "fte": 1312.0, "cap": 1318.0, "util": 99.54, "rate": 0.84, "fees": 34376.0, "nps": 51.6, "attr": 21.6, "age": 11.02, "region": "Europe" }, { "enq": 920.0, "fte": 1710.0, "cap": 1871.0, "util": 91.39, "rate": 0.54, "fees": 22321.0, "nps": 30.4, "attr": 20.5, "age": 11.46, "region": "South East Asia & India" }, { "enq": 602.0, "fte": 1031.0, "cap": 1203.0, "util": 85.70, "rate": 0.58, "fees": 36790.0, "nps": 39.6, "attr": 11.0, "age": 6.98, "region": "The Americas" }, { "enq": 648.0, "fte": 1201.0, "cap": 1317.0, "util": 91.19, "rate": 0.54, "fees": 40748.0, "nps": 54.3, "attr": 14.5, "age": 10.63, "region": "China International" }, { "enq": 377.0, "fte": 960.0, "cap": 1194.0, "util": 80.40, "rate": 0.39, "fees": 33934.0, "nps": 51.8, "attr": 4.8, "age": -0.09, "region": "China International" }, { "enq": 797.0, "fte": 1495.0, "cap": 1756.0, "util": 85.14, "rate": 0.53, "fees": 23855.0, "nps": 62.2, "attr": 6.8, "age": 6.29, "region": "South East Asia & India" }, { "enq": 1516.0, "fte": 2438.0, "cap": 2595.0, "util": 93.95, "rate": 0.62, "fees": 21862.0, "nps": 50.6, "attr": 16.7, "age": 7.35, "region": "Middle East" }, { "enq": 1154.0, "fte": 1740.0, "cap": 1681.0, "util": 103.51, "rate": 0.66, "fees": 22062.0, "nps": 19.9, "attr": 24.2, "age": 6.19, "region": "South East Asia & India" }, { "enq": 751.0, "fte": 1305.0, "cap": 1466.0, "util": 89.02, "rate": 0.58, "fees": 47629.0, "nps": 60.8, "attr": 11.2, "age": 4.47, "region": "The Americas" }, { "enq": 606.0, "fte": 1312.0, "cap": 1629.0, "util": 80.54, "rate": 0.46, "fees": 25057.0, "nps": 54.6, "attr": 8.5, "age": 5.87, "region": "South East Asia & India" }];

        // VERIFIED DATA FROM CSV ANALYSIS (Feb 2026)
        // All ρ values verified against School Level Data.csv (Pearson r)
        const hypotheses = [
            // Operational (ops)
            { id: "H1", cat: "ops", name: "Scale Effect", desc: "Larger schools (Size) generate significantly more enquiries due to market presence.", rho: 0.83, p: 0.001, n: 503, sig: true, type: "ρ" },
            { id: "H2", cat: "ops", name: "Growth Strain", desc: "High teacher attrition correlates negatively with demand (r=-0.47), as turnover undermines market trust.", rho: -0.47, p: 0.001, n: 503, sig: true, type: "ρ" },
            { id: "H3", cat: "ops", name: "Leader Stability", desc: "Principal tenure shows no meaningful correlation with enquiry rate (n=143, sparse data).", rho: 0.00, p: 0.98, n: 143, sig: false, type: "ρ" },
            { id: "H4", cat: "ops", name: "Retention Momentum", desc: "Year-on-year conversion rate growth shows no significant link to volume (n=66, sparse data).", rho: -0.07, p: 0.58, n: 66, sig: false, type: "ρ" },

            // Curriculum (curr)
            { id: "H5", cat: "curr", name: "IB Quality Magnet", desc: "IB curriculum correlates with the highest average NPS (47.0 vs 44 for others).", rho: 0.02, p: 0.62, n: 421, sig: true, type: "ρ" },
            { id: "H6", cat: "curr", name: "IGCSE Volume Engine", desc: "IGCSE programs drive the highest raw enquiry volumes (+112% vs mean).", rho: 0.09, p: 0.04, n: 421, sig: true, type: "ρ" },
            { id: "H7", cat: "curr", name: "A-Level Core", desc: "A-Levels maintain steady demand (+6%) as the global standard for UK-bound students.", rho: 0.09, p: 0.04, n: 421, sig: true, type: "ρ" },
            { id: "H8", cat: "curr", name: "Multi-Program Lift", desc: "Offering multiple curricula shows negligible impact on enquiry rate.", rho: 0.00, p: 0.95, n: 421, sig: false, type: "ρ" },

            // Market (market)
            { id: "H9", cat: "market", name: "Lead Velocity", desc: "Raw lead intensity (r=0.94) is the primary driver of final enquiry volume.", rho: 0.94, p: 0.001, n: 503, sig: true, type: "ρ" },
            { id: "H10", cat: "market", name: "Regional Bias", desc: "The Middle East leads with a rate of 0.63 enquiries/student across regions.", rho: 0.63, p: 0.001, n: 503, sig: true, type: "H" },
            { id: "H11", cat: "market", name: "Wealth Density", desc: "HNWI concentration shows no significant link to enquiry rate (r=-0.01, n=90).", rho: -0.01, p: 0.92, n: 90, sig: false, type: "ρ" },
            { id: "H12", cat: "market", name: "Fee Sensitivity", desc: "Higher fees act as a volume constraint (r=-0.22) in competitive markets.", rho: -0.22, p: 0.001, n: 503, sig: true, type: "ρ" },

            // Quality & Sentiment (quality)
            { id: "H13", cat: "quality", name: "Engagement Signal", desc: "NPS response volume (r=0.74) predicts demand better than the score itself.", rho: 0.74, p: 0.001, n: 503, sig: true, type: "ρ" },
            { id: "H14", cat: "quality", name: "Principal Quality", desc: "High perceived Principal quality leads (+0.11) community satisfaction.", rho: 0.11, p: 0.04, n: 194, sig: true, type: "ρ" },
            { id: "H15", cat: "quality", name: "Intent Channel", desc: "Desktop users (+0.17) show higher 'High-Intent' enquiry behavior than mobile.", rho: 0.17, p: 0.01, n: 69, sig: true, type: "ρ" },
            { id: "H16", cat: "quality", name: "Relocation Driver", desc: "Expat concentration shows a weak positive link (+0.06) with enquiry rate.", rho: 0.06, p: 0.28, n: 284, sig: false, type: "ρ" },

            // Rejected (rejected)
            { id: "H17", cat: "rejected", name: "The NPS Paradox", desc: "NPS scores show a modest positive correlation (r=0.25) with enquiry rate, but not a strong driver.", rho: 0.25, p: 0.001, n: 503, sig: true, type: "ρ" },
            { id: "H18", cat: "rejected", name: "Academic Performance", desc: "Standardized academic results show zero correlation with enquiry rate.", rho: 0.03, p: 0.65, n: 238, sig: false, type: "ρ" },
            { id: "H19", cat: "rejected", name: "Maintenance Capex", desc: "Facility maintenance spending shows no significant link to immediate volume.", rho: 0.05, p: 0.47, n: 203, sig: false, type: "ρ" },
            { id: "H20", cat: "rejected", name: "School Age", desc: "School maturity (years open) does not predict enquiry intensity.", rho: 0.08, p: 0.10, n: 411, sig: false, type: "ρ" }
        ];

        const regions = [
            { name: "Middle East", value: 0.63 },
            { name: "China Bilingual", value: 0.62 },
            { name: "The Americas", value: 0.61 },
            { name: "Europe", value: 0.57 },
            { name: "SEA & India", value: 0.54 },
            { name: "China International", value: 0.50 }
        ];

        // Render Hypothesis Cards
        function renderCards(containerId, category) {
            const items = hypotheses.filter(h => h.cat === category);
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(h => `
        <div class="h-card ${h.sig ? 'sig' : 'not-sig'}">
            <div class="verdict-badge ${h.sig ? 'confirmed' : 'rejected'}">${h.sig ? 'Confirmed' : 'Rejected'}</div>
            <div class="h-id">${h.id}</div>
            <div class="h-name">${h.name}</div>
            <div class="h-desc">${h.desc}</div>
            <div class="h-metrics">
                <div class="metric ${h.rho >= 0 ? 'pos' : 'neg'}">${h.type === '%' ? '+' + h.pct + '%' : h.type === 'H' ? 'H=' + h.rho : 'ρ=' + h.rho.toFixed(2)}</div>
                <div class="metric">n=${h.n}</div>
                <div class="metric">p=${h.p < 0.001 ? '<.001' : h.p.toFixed(3)}</div>
            </div>
        </div>
    `).join('');
        }

        // Draw Effect Chart
        function drawEffectChart() {
            const container = document.getElementById("effect-chart");
            const data = hypotheses.filter(h => h.type === 'ρ').sort((a, b) => b.rho - a.rho);
            const width = Math.min(container.offsetWidth, 900), height = data.length * 32 + 40;
            const margin = { top: 10, right: 60, bottom: 30, left: 220 };

            const svg = d3.select("#effect-chart").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-0.8, 1.0]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleBand().domain(data.map(d => d.name)).range([0, height - margin.top - margin.bottom]).padding(0.3);

            // Zero line
            g.append("line").attr("x1", x(0)).attr("x2", x(0)).attr("y1", 0).attr("y2", height - margin.top - margin.bottom)
                .attr("stroke", "#4b5563").attr("stroke-dasharray", "3,3");

            // X axis
            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(6)).selectAll("text").attr("fill", "#9ca3af");

            // Y axis
            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("fill", "#e5e7eb").attr("font-size", "11px");

            // Bars
            g.selectAll(".bar").data(data).join("rect")
                .attr("x", d => x(Math.min(0, d.rho)))
                .attr("y", d => y(d.name))
                .attr("width", d => Math.abs(x(d.rho) - x(0)))
                .attr("height", y.bandwidth())
                .attr("fill", d => !d.sig ? "#6b7280" : d.rho >= 0 ? "#10b981" : "#ef4444")
                .attr("rx", 3)
                .attr("opacity", d => d.sig ? 1 : 0.5)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `<strong>${d.id}: ${d.name}</strong><br>ρ = ${d.rho.toFixed(3)}<br>p = ${d.p < 0.001 ? '<0.001' : d.p.toFixed(4)}<br>n = ${d.n}<br>${d.sig ? '✓ Significant' : '✗ Not significant'}`))
                .on("mouseout", hideTip);

            // Labels
            g.selectAll(".label").data(data).join("text")
                .attr("x", d => x(d.rho) + (d.rho >= 0 ? 6 : -6))
                .attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                .attr("text-anchor", d => d.rho >= 0 ? "start" : "end")
                .attr("fill", "#e5e7eb").attr("font-size", "10px").attr("font-family", "'JetBrains Mono', monospace")
                .text(d => d.rho.toFixed(2));
        }

        // Draw Region Chart
        function drawRegionChart() {
            const container = document.getElementById("region-chart");
            const width = Math.min(container.offsetWidth, 700), height = 220;
            const margin = { top: 10, right: 60, bottom: 20, left: 120 };

            const svg = d3.select("#region-chart").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([0, 1.0]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleBand().domain(regions.map(d => d.name)).range([0, height - margin.top - margin.bottom]).padding(0.35);
            const color = d3.scaleSequential(d3.interpolateYlOrRd).domain([0, regions.length - 1]);

            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("fill", "#e5e7eb");

            g.selectAll(".bar").data(regions).join("rect")
                .attr("x", 0).attr("y", d => y(d.name))
                .attr("width", d => x(d.value)).attr("height", y.bandwidth())
                .attr("fill", (d, i) => color(regions.length - 1 - i)).attr("rx", 4)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `<strong>${d.name}</strong><br>${d.value.toFixed(2)} enquiries/student`))
                .on("mouseout", hideTip);

            g.selectAll(".label").data(regions).join("text")
                .attr("x", d => x(d.value) + 8).attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                .attr("fill", "#e5e7eb").attr("font-size", "12px").attr("font-weight", "600")
                .text(d => d.value.toFixed(2));
        }

        // Draw Operations Scatter (Attrition vs Rate)
        function drawOpsChart() {
            const container = document.getElementById("ops-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 260;
            const margin = { top: 10, right: 20, bottom: 50, left: 50 };

            const svg = d3.select("#ops-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Real CSV Data: Teacher Attrition vs Enquiry Rate
            const data = sampleData.map(d => ({ x: d.attr, y: d.rate }));

            const x = d3.scaleLinear().domain([0, 35]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleLinear().domain([0, 1.1]).range([height - margin.top - margin.bottom, 0]);

            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)).selectAll("text").attr("fill", "#9ca3af");
            g.append("text").attr("x", (width - margin.left) / 2).attr("y", height - margin.top - 10).attr("fill", "#6b7280").attr("font-size", "10px").text("Teacher Attrition (%)");

            g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").attr("fill", "#9ca3af");

            g.selectAll("circle").data(data).join("circle")
                .attr("cx", d => x(d.x)).attr("cy", d => y(d.y)).attr("r", 6)
                .attr("fill", "#ef4444").attr("opacity", 0.8)
                .attr("stroke", "#fff").attr("stroke-width", 1)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `Attrition: ${d.x.toFixed(1)}%<br>Rate: ${d.y.toFixed(2)}`))
                .on("mouseout", hideTip);
        }

        // Draw Curriculum Bar (Rate)
        function drawCurrChart() {
            const container = document.getElementById("curr-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 200;
            const margin = { top: 10, right: 20, bottom: 30, left: 100 };

            const svg = d3.select("#curr-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Verified rates from CSV: avg enquiries_started / StudentFTE by Prevailing_Curriculum
            const data = [
                { name: "IGCSE", val: 0.84, color: "#10b981" },
                { name: "IB", val: 0.58, color: "#10b981" },
                { name: "AP", val: 0.55, color: "#fcd34d" },
                { name: "A-Levels", val: 0.54, color: "#fcd34d" }
            ];

            const x = d3.scaleLinear().domain([0, 1]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleBand().domain(data.map(d => d.name)).range([0, height - margin.top - margin.bottom]).padding(0.3);

            g.append("g").call(d3.axisLeft(y).tickSize(0)).selectAll("text").attr("fill", "#e5e7eb");

            g.selectAll("rect").data(data).join("rect")
                .attr("x", 0).attr("y", d => y(d.name))
                .attr("width", d => x(d.val)).attr("height", y.bandwidth())
                .attr("fill", d => d.color).attr("rx", 3)
                .on("mouseover", (e, d) => showTip(e, `<strong>${d.name}</strong><br>Rate: ${d.val} enq/student`))
                .on("mouseout", hideTip);

            g.selectAll(".label").data(data).join("text")
                .attr("x", d => x(d.val) + 5).attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                .attr("fill", "#e5e7eb").attr("font-size", "10px").text(d => d.val);
        }

        // Draw Quality Scatter (NPS vs Rate - Flat)
        function drawQualityChart() {
            const container = document.getElementById("quality-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 260;
            const margin = { top: 10, right: 20, bottom: 50, left: 50 };

            const svg = d3.select("#quality-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Real CSV Data: NPS vs Enquiry Rate
            const data = sampleData.map(d => ({ x: d.nps, y: d.rate }));

            const x = d3.scaleLinear().domain([15, 75]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleLinear().domain([0, 1.1]).range([height - margin.top - margin.bottom, 0]);

            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)).selectAll("text").attr("fill", "#9ca3af");
            g.append("text").attr("x", (width - margin.left) / 2).attr("y", height - margin.top - 10).attr("fill", "#6b7280").attr("font-size", "10px").text("NPS Score");

            g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").attr("fill", "#9ca3af");

            g.selectAll("circle").data(data).join("circle")
                .attr("cx", d => x(d.x)).attr("cy", d => y(d.y)).attr("r", 6)
                .attr("fill", "#6b7280").attr("opacity", 0.6)
                .attr("stroke", "#fff").attr("stroke-width", 1)
                .style("cursor", "pointer")
                .on("mouseover", (e, d) => showTip(e, `NPS: ${d.x.toFixed(0)}<br>Rate: ${d.y.toFixed(2)}`))
                .on("mouseout", hideTip);

            g.append("line").attr("x1", x(15)).attr("y1", y(0.7)).attr("x2", x(75)).attr("y2", y(0.7))
                .attr("stroke", "#ef4444").attr("stroke-width", 2).attr("stroke-dasharray", "4,4");
        }

        // Draw Rejected Scatter (Age vs Rate)
        function drawRejectedChart() {
            const container = document.getElementById("rejected-chart");
            if (!container) return;
            const width = Math.min(container.offsetWidth, 700), height = 260;
            const margin = { top: 10, right: 20, bottom: 50, left: 50 };

            const svg = d3.select("#rejected-chart").html("").append("svg").attr("width", width).attr("height", height);
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Real CSV Data: School Age vs Rate
            const data = sampleData.map(d => ({ x: d.age, y: d.rate }));

            const x = d3.scaleLinear().domain([-5, 25]).range([0, width - margin.left - margin.right]);
            const y = d3.scaleLinear().domain([0, 1.1]).range([height - margin.top - margin.bottom, 0]);

            g.append("g").attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)).selectAll("text").attr("fill", "#9ca3af");
            g.append("text").attr("x", (width - margin.left) / 2).attr("y", height - margin.top - 10).attr("fill", "#6b7280").attr("font-size", "10px").text("School Age (Years)");

            g.append("g").call(d3.axisLeft(y).ticks(5)).selectAll("text").attr("fill", "#9ca3af");

            g.selectAll("circle").data(data).join("circle")
                .attr("cx", d => x(d.x)).attr("cy", d => y(d.y)).attr("r", 4)
                .attr("fill", "#6b7280").attr("opacity", 0.4)
                .on("mouseover", (e, d) => showTip(e, `Age: ${d.x.toFixed(0)} yrs<br>Rate: ${d.y.toFixed(2)}`))
                .on("mouseout", hideTip);
        }

        // Initialize
        renderCards("ops-grid", "ops");
        renderCards("curr-grid", "curr");
        renderCards("market-grid", "market");
        renderCards("quality-grid", "quality");
        renderCards("rejected-grid", "rejected");
        drawEffectChart();
        drawRegionChart();

        // New Charts
        drawOpsChart();
        drawCurrChart();
        drawQualityChart();
        drawRejectedChart();

        // NYT Story Visualization: Actual CSV Data Samples
        // Clear container to prevent duplicates
        d3.select("#story-viz").html("");

        const storyData = sampleData.map((d, i) => ({
            id: i,
            nps: d.nps,
            fees: d.fees,
            scale: d.fte,
            rate: d.rate,
            region: d.region
        }));

        const storySvg = d3.select("#story-viz").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .attr("viewBox", "0 0 800 500");

        const sx = d3.scaleLinear().domain([15, 75]).range([100, 750]);
        const sy = d3.scaleLinear().domain([0, 1.2]).range([450, 50]);
        const sFees = d3.scaleLinear().domain([15000, 50000]).range([100, 750]);
        const sScale = d3.scaleLinear().domain([700, 2600]).range([100, 750]);

        // Initial Axes
        storySvg.append("g").attr("class", "x-axis").attr("transform", "translate(0,450)")
            .call(d3.axisBottom(sx).ticks(5)).style("opacity", 0);
        storySvg.append("g").attr("class", "y-axis").attr("transform", "translate(100,0)")
            .call(d3.axisLeft(sy).ticks(5)).style("opacity", 0);

        storySvg.append("text").attr("class", "x-label").attr("x", 425).attr("y", 490)
            .attr("text-anchor", "middle").attr("fill", "#9ca3af").attr("font-size", "12px").text("NPS Score").style("opacity", 0);

        storySvg.append("text").attr("class", "y-label").attr("x", -250).attr("y", 30)
            .attr("transform", "rotate(-90)").attr("text-anchor", "middle").attr("fill", "#9ca3af").attr("font-size", "12px").text("Enquiries per Student (Rate)").style("opacity", 0);

        storySvg.append("text").attr("class", "intro-text").attr("x", 400).attr("y", 250)
            .attr("text-anchor", "middle").attr("fill", "#4b5563").attr("font-size", "0.85rem")
            .attr("letter-spacing", "2px").style("opacity", 1).text("SCROLL TO ANALYZE DRIVERS");

        // Helper: Simple Linear Regression
        function getRegression(data, xAccessor, yAccessor, xScale, yScale) {
            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            data.forEach(d => {
                const x = xAccessor(d);
                const y = yAccessor(d);
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            });
            const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const b = (sumY - m * sumX) / n;

            // Get domain bounds for the line
            const xDomain = xScale.domain();
            const x1 = xDomain[0];
            const y1 = m * x1 + b;
            const x2 = xDomain[1];
            const y2 = m * x2 + b;

            return { x1: xScale(x1), y1: yScale(y1), x2: xScale(x2), y2: yScale(y2) };
        }

        const regressionLine = storySvg.append("line")
            .attr("class", "regression-line")
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "5,5")
            .style("opacity", 0);

        function updateStory(step) {
            const t = d3.transition().duration(800);

            if (step == 1) {
                storySvg.selectAll("circle").transition(t).attr("r", 0).remove();
                storySvg.select(".x-axis").transition(t).style("opacity", 0);
                storySvg.select(".y-axis").transition(t).style("opacity", 0);
                storySvg.select(".x-label").transition(t).style("opacity", 0);
                storySvg.select(".y-label").transition(t).style("opacity", 0);
                storySvg.select(".intro-text").transition(t).style("opacity", 1);
                regressionLine.transition(t).style("opacity", 0);
                return; // Exit early
            }

            storySvg.select(".intro-text").transition(t).style("opacity", 0);
            storySvg.select(".x-axis").transition(t).style("opacity", 1);
            storySvg.select(".y-axis").transition(t).style("opacity", 1);
            storySvg.select(".y-label").transition(t).style("opacity", 1);

            // Generic Circle Update Pattern
            const updateCircles = (data, getHtml, getX, getY, getR, color, opacity) => {
                const circles = storySvg.selectAll("circle").data(data, d => d.id);

                circles.enter().append("circle")
                    .attr("r", 0)
                    .attr("cx", d => getX(d))
                    .attr("cy", d => getY(d))
                    .merge(circles)
                    .on("mouseover", (e, d) => showTip(e, getHtml(d)))
                    .on("mouseout", hideTip)
                    .transition(t)
                    .attr("cx", d => getX(d))
                    .attr("cy", d => getY(d))
                    .attr("r", d => getR(d))
                    .attr("fill", color)
                    .attr("opacity", opacity);

                circles.exit().transition(t).attr("r", 0).remove();
            };

            if (step == 2) {
                const fakeData = storyData.map(d => ({ ...d, fakeRate: (d.nps + 30) / 100 }));
                sx.domain([15, 75]);
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sx));
                storySvg.select(".y-axis").transition(t).call(d3.axisLeft(sy));
                storySvg.select(".x-label").transition(t).style("opacity", 1).text("NPS Score (Hypothetical: Quality = Efficiency)");

                updateCircles(fakeData,
                    d => `<strong>Hypothetical Result</strong><br>NPS: ${d.nps.toFixed(0)}<br>Rate: ${d.fakeRate.toFixed(2)}`,
                    d => sx(d.nps), d => sy(d.fakeRate), d => 7, "#fcd34d", 0.7
                );

                const reg = getRegression(fakeData, d => d.nps, d => d.fakeRate, sx, sy);
                regressionLine.transition(t)
                    .attr("x1", reg.x1).attr("y1", reg.y1).attr("x2", reg.x2).attr("y2", reg.y2)
                    .attr("stroke", "#fcd34d").style("opacity", 0.8);
            }

            if (step == 3) {
                sx.domain([15, 75]);
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sx));
                storySvg.select(".y-axis").transition(t).call(d3.axisLeft(sy));
                storySvg.select(".x-label").style("opacity", 1).text("NPS Score (The Real Satisfaction Link)");

                updateCircles(storyData,
                    d => `<strong>Actual School Performance</strong><br>NPS: ${d.nps.toFixed(0)}<br>Rate: ${d.rate.toFixed(2)}`,
                    d => sx(d.nps), d => sy(d.rate), d => 7, "#6b7280", 0.6
                );

                const reg = getRegression(storyData, d => d.nps, d => d.rate, sx, sy);
                regressionLine.transition(t)
                    .attr("x1", reg.x1).attr("y1", reg.y1).attr("x2", reg.x2).attr("y2", reg.y2)
                    .attr("stroke", "#9ca3af").style("opacity", 0.6);
            }

            if (step == 4) {
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sFees).tickFormat(d => "$" + d / 1000 + "k"));
                storySvg.select(".y-axis").transition(t).call(d3.axisLeft(sy));
                storySvg.select(".x-label").style("opacity", 1).text("Average Fees (Market Filter Effect)");

                updateCircles(storyData,
                    d => `<strong>Pricing Pressure</strong><br>Fees: $${(d.fees / 1000).toFixed(1)}k<br>Rate: ${d.rate.toFixed(2)}`,
                    d => sFees(d.fees), d => sy(d.rate), d => 7, "#ef4444", 0.8
                );

                const reg = getRegression(storyData, d => d.fees, d => d.rate, sFees, sy);
                regressionLine.transition(t)
                    .attr("x1", reg.x1).attr("y1", reg.y1).attr("x2", reg.x2).attr("y2", reg.y2)
                    .attr("stroke", "#ef4444").style("opacity", 0.5);
            }

            if (step == 5) {
                storySvg.select(".x-axis").transition(t).call(d3.axisBottom(sScale));
                storySvg.select(".y-axis").transition(t).call(d3.axisLeft(sy));
                storySvg.select(".x-label").style("opacity", 1).text("Enrolled Students (Scale Effect: r=0.83)");

                updateCircles(storyData,
                    d => `<strong>The Scale Driver</strong><br>Students: ${d.scale.toFixed(0)}<br>Rate: ${d.rate.toFixed(2)}`,
                    d => sScale(d.scale), d => sy(d.rate), d => Math.max(3, d.scale / 120), "#10b981", 0.8
                );

                const reg = getRegression(storyData, d => d.scale, d => d.rate, sScale, sy);
                regressionLine.transition(t)
                    .attr("x1", reg.x1).attr("y1", reg.y1).attr("x2", reg.x2).attr("y2", reg.y2)
                    .attr("stroke", "#10b981").style("opacity", 0.8);
            }
        }

        // Observer
        const steps = document.querySelectorAll('.step');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const step = entry.target.getAttribute('data-step');
                    updateStory(step);
                    steps.forEach(s => s.classList.remove('active'));
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.5 }); // Trigger when 50% visible
        steps.forEach(step => observer.observe(step));

    </script>
</body>

</html>